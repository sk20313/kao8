<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>麻衣相法遊戲屋 - AI面相分析</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #8e3b1d;
            --secondary-color: #d9a566;
            --accent-color: #b22222;
            --dark-bg: #1a120b;
            --light-bg: #f5e8c9;
            --text-dark: #3c2a21;
            --text-light: #f9f5eb;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a120b"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%233c2a21" stroke-width="0.5"/></svg>');
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background: linear-gradient(to bottom, #2c1a0d, #1a120b);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            border: 2px solid var(--secondary-color);
            position: relative;
        }
        
        /* 装饰元素 - 传统图案 */
        .decoration {
            position: absolute;
            opacity: 0.1;
            pointer-events: none;
        }
        
        .decoration.top-left {
            top: 20px;
            left: 20px;
            font-size: 80px;
            transform: rotate(-15deg);
        }
        
        .decoration.bottom-right {
            bottom: 20px;
            right: 20px;
            font-size: 80px;
            transform: rotate(15deg);
        }
        
        header {
            background: rgba(60, 42, 33, 0.7);
            padding: 25px;
            text-align: center;
            border-bottom: 3px solid var(--secondary-color);
            position: relative;
            z-index: 2;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: var(--secondary-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 2px;
            position: relative;
            display: inline-block;
        }
        
        h1:after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 3px;
            background: var(--accent-color);
            border-radius: 2px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 10px auto 0;
            color: #d9a566;
            font-style: italic;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 30px;
            gap: 30px;
            position: relative;
            z-index: 2;
        }
        
        .upload-section, .result-section {
            flex: 1;
            min-width: 300px;
            padding: 25px;
            background: rgba(40, 28, 21, 0.7);
            border-radius: 15px;
            border: 1px solid rgba(217, 165, 102, 0.3);
        }
        
        .result-section {
            display: flex;
            flex-direction: column;
        }
        
        h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            font-size: 1.5rem;
        }
        
        .upload-area {
            border: 3px dashed var(--secondary-color);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 25px;
            background: rgba(28, 20, 13, 0.5);
            position: relative;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .upload-area:hover {
            background: rgba(60, 42, 33, 0.6);
            transform: translateY(-5px);
        }
        
        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--secondary-color);
            transition: transform 0.3s;
        }
        
        .upload-area:hover .upload-icon {
            transform: scale(1.1);
        }
        
        .btn, .ai-btn, .control-btn {
            border: none;
            cursor: pointer;
            transition: 0.3s;
            font-weight: bold;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn, .control-btn {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: var(--text-light);
            padding: 16px 30px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            width: 100%;
            margin: 20px 0;
            font-size: 1.1rem;
        }
        
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .ai-btn {
            background: linear-gradient(to right, #d9a566, #b8860b);
            color: var(--text-dark);
            padding: 17px 35px;
            border-radius: 50px;
            display: block;
            margin: 25px auto;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            font-weight: 700;
        }
        
        .ai-btn:hover, .btn:hover, .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }
        
        .face-canvas-container {
            position: relative;
            width: 100%;
            margin: 20px 0;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #faceCanvas {
            max-width: 100%;
            max-height: 400px;
            border: 2px solid var(--secondary-color);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            margin: 0 auto;
            display: block;
        }
        
        .analysis-result {
            background: rgba(28, 20, 13, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(217, 165, 102, 0.3);
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .analysis-result h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.4rem;
        }
        
        .trait-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .trait-card {
            background: rgba(60, 42, 33, 0.5);
            border-radius: 10px;
            padding: 15px;
            border-left: 3px solid var(--accent-color);
        }
        
        .trait-card h4 {
            color: var(--secondary-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .trait-card p {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 5px solid rgba(217, 165, 102, 0.3);
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .face-shape {
            background: #4f8bf9;
        }
        
        .eyes {
            background: #ff6b6b;
        }
        
        .nose {
            background: #1dd1a1;
        }
        
        .mouth {
            background: #feca57;
        }
        
        .jaw {
            background: #5f27cd;
        }
        
        .instructions {
            background: rgba(217, 165, 102, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid rgba(217, 165, 102, 0.3);
        }
        
        .instructions h4 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .upload-section, .result-section {
                min-width: 100%;
            }
            
            .trait-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="decoration top-left">囍</div>
        <div class="decoration bottom-right">福</div>
        
        <header>
            <h1><i class="fas fa-mask"></i> 麻衣相法遊戲屋</h1>
            <p class="subtitle">基於千年《麻衣神相》理論的AI面相分析系統</p>
        </header>

        <div class="main-content">
            <div class="upload-section">
                <h2><i class="fas fa-upload"></i> 面相分析步驟</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon"><i class="fas fa-camera"></i></div>
                    <p>點擊或拖放正面清晰的面部照片到這裡</p>
                    <p class="small">(建議使用光線良好的正面照片)</p>
                    <input type="file" id="fileInput" accept="image/*" hidden />
                </div>
                
                <div class="instructions">
                    <h4><i class="fas fa-info-circle"></i> 上傳須知</h4>
                    <ul>
                        <li>請上傳清晰、正面的臉部照片</li>
                        <li>避免戴眼鏡、帽子或過多飾品</li>
                        <li>保持自然表情，勿做誇張表情</li>
                        <li>系統將分析額頭、眉眼、鼻、口、下巴等特徵</li>
                    </ul>
                </div>

                <button class="ai-btn" id="aiAnalysisBtn" disabled>
                    <i class="fas fa-magic"></i> 開始面相分析
                </button>
                
                <div class="controls">
                    <button class="control-btn" id="toggleMeshBtn">
                        <i class="fas fa-border-all"></i> 顯示/隱藏分析網格
                    </button>
                    <button class="control-btn" id="exportJsonBtn">
                        <i class="fas fa-download"></i> 匯出分析報告
                    </button>
                </div>
            </div>

            <div class="result-section">
                <h2><i class="fas fa-chart-line"></i> 分析結果</h2>
                
                <div class="face-canvas-container">
                    <canvas id="faceCanvas" width="500" height="500"></canvas>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color face-shape"></div>
                            <span>臉型輪廓</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color eyes"></div>
                            <span>眉眼特徵</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color nose"></div>
                            <span>鼻相分析</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color mouth"></div>
                            <span>口唇分析</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color jaw"></div>
                            <span>下巴分析</span>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-result" id="analysisResult">
                    <h3><i class="fas fa-scroll"></i> 面相分析報告</h3>
                    <p class="waiting-text">請上傳照片並點擊"開始面相分析"按鈕</p>
                    
                    <div class="trait-list" id="traitList" style="display:none">
                        <!-- 面相特徵將由JS動態生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>AI正在分析面相，解讀命運玄機...</p>
        </div>
    </div>

    <script>
        // 初始化DOM元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const aiBtn = document.getElementById('aiAnalysisBtn');
        const meshBtn = document.getElementById('toggleMeshBtn');
        const exportBtn = document.getElementById('exportJsonBtn');
        const canvas = document.getElementById('faceCanvas');
        const ctx = canvas.getContext('2d');
        const analysisResult = document.getElementById('analysisResult');
        const traitList = document.getElementById('traitList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const waitingText = analysisResult.querySelector('.waiting-text');

        // 全局變量
        let loadedImage = null;
        let faceDetection = null;
        let showMesh = true;
        let analysisData = {
            faceShape: '',
            forehead: '',
            eyebrows: '',
            eyes: '',
            nose: '',
            mouth: '',
            jaw: '',
            overall: ''
        };

        // 初始化face-api.js模型
        async function initFaceAPI() {
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights'),
                    faceapi.nets.faceExpressionNet.loadFromUri('https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights')
                ]);
                console.log('FaceAPI models loaded');
            } catch (e) {
                console.error('Error loading FaceAPI models:', e);
                alert('無法載入AI模型，請刷新頁面重試');
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initFaceAPI();
        });

        // 上傳處理
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFile);
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = 'rgba(90, 63, 48, 0.6)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = 'rgba(28, 20, 13, 0.5)';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = 'rgba(28, 20, 13, 0.5)';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFile();
            }
        });

        function handleFile() {
            const file = fileInput.files[0];
            if (!file || !file.type.match('image.*')) return alert('請選擇有效的圖片檔');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // 調整Canvas大小
                    const maxSize = 500;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, width, height);
                    loadedImage = img;
                    aiBtn.disabled = false;
                    
                    // 清除之前的結果
                    traitList.style.display = 'none';
                    waitingText.style.display = 'block';
                    analysisData = {};
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // AI分析按鈕
        aiBtn.addEventListener('click', async () => {
            if (!loadedImage) return alert('請先上傳圖片');
            
            // 顯示加載指示器
            loadingIndicator.style.display = 'block';
            
            try {
                // 使用face-api.js檢測人臉
                const detections = await faceapi.detectSingleFace(
                    canvas, 
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceLandmarks();
                
                if (!detections) {
                    loadingIndicator.style.display = 'none';
                    return alert('未檢測到人臉，請上傳清晰的正面照片');
                }
                
                faceDetection = detections;
                
                // 繪製人臉網格
                drawFaceMesh();
                
                // 進行面相分析
                analyzeFacialFeatures();
                
                // 顯示分析結果
                displayAnalysisResults();
                
                // 隱藏加載指示器
                loadingIndicator.style.display = 'none';
                
            } catch (error) {
                console.error('Face detection error:', error);
                loadingIndicator.style.display = 'none';
                alert('面相分析失敗，請重試');
            }
        });

        // 繪製人臉網格
        function drawFaceMesh() {
            if (!faceDetection || !loadedImage) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(loadedImage, 0, 0, canvas.width, canvas.height);
            
            if (!showMesh) return;
            
            const landmarks = faceDetection.landmarks;
            const points = landmarks.positions;
            
            // 繪製臉部輪廓
            ctx.beginPath();
            ctx.strokeStyle = '#4f8bf9';
            ctx.lineWidth = 2;
            for (let i = 0; i < 17; i++) {
                const pt = points[i];
                if (i === 0) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            }
            ctx.stroke();
            
            // 繪製左眉
            ctx.beginPath();
            ctx.strokeStyle = '#ff6b6b';
            for (let i = 17; i < 22; i++) {
                const pt = points[i];
                if (i === 17) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            }
            ctx.stroke();
            
            // 繪製右眉
            ctx.beginPath();
            for (let i = 22; i < 27; i++) {
                const pt = points[i];
                if (i === 22) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            }
            ctx.stroke();
            
            // 繪製鼻子
            ctx.beginPath();
            ctx.strokeStyle = '#1dd1a1';
            for (let i = 27; i < 36; i++) {
                const pt = points[i];
                if (i === 27) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            }
            ctx.stroke();
            
            // 繪製左眼
            ctx.beginPath();
            ctx.strokeStyle = '#ff6b6b';
            for (let i = 36; i < 42; i++) {
                const pt = points[i];
                if (i === 36) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            }
            ctx.closePath();
            ctx.stroke();
            
            // 繪製右眼
            ctx.beginPath();
            for (let i = 42; i < 48; i++) {
                const pt = points[i];
                if (i === 42) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            }
            ctx.closePath();
            ctx.stroke();
            
            // 繪製嘴唇外輪廓
            ctx.beginPath();
            ctx.strokeStyle = '#feca57';
            for (let i = 48; i < 60; i++) {
                const pt = points[i];
                if (i === 48) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            }
            ctx.closePath();
            ctx.stroke();
            
            // 繪製嘴唇內輪廓
            ctx.beginPath();
            for (let i = 60; i < 68; i++) {
                const pt = points[i];
                if (i === 60) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            }
            ctx.closePath();
            ctx.stroke();
            
            // 繪製下巴
            ctx.beginPath();
            ctx.strokeStyle = '#5f27cd';
            ctx.moveTo(points[8].x, points[8].y);
            for (let i = 8; i >= 0; i--) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            ctx.stroke();
        }

        // 面相分析
        function analyzeFacialFeatures() {
            if (!faceDetection) return;
            
            const points = faceDetection.landmarks.positions;
            
            // 臉型分析
            const faceWidth = points[16].x - points[0].x;
            const faceHeight = points[8].y - points[27].y;
            const faceRatio = faceWidth / faceHeight;
            
            if (faceRatio > 0.85) {
                analysisData.faceShape = '圓臉';
                analysisData.faceShapeDesc = '圓臉之人通常性格開朗，人際關係良好，容易相處。在麻衣相法中，圓臉代表福氣，晚年運勢較佳。';
            } else if (faceRatio < 0.7) {
                analysisData.faceShape = '長臉';
                analysisData.faceShapeDesc = '長臉之人通常思維敏捷，具有創造力，但容易思慮過多。麻衣相法認為長臉者中年運勢較強。';
            } else {
                analysisData.faceShape = '方臉';
                analysisData.faceShapeDesc = '方臉之人通常性格堅毅，做事有原則，領導能力強。在麻衣相法中，方臉代表事業運勢穩固。';
            }
            
            // 額頭分析
            const foreheadWidth = points[21].x - points[22].x;
            const foreheadHeight = points[27].y - points[21].y;
            const foreheadRatio = foreheadWidth / foreheadHeight;
            
            if (foreheadRatio > 1.8) {
                analysisData.forehead = '寬闊飽滿';
                analysisData.foreheadDesc = '寬闊飽滿的額頭代表智慧與遠見，麻衣相法認為此乃富貴之相，事業運強，少年得志。';
            } else if (foreheadRatio < 1.4) {
                analysisData.forehead = '狹窄';
                analysisData.foreheadDesc = '額頭較窄者通常早年運勢較弱，但中年後運勢上升。麻衣相法建議此面相者需更加努力。';
            } else {
                analysisData.forehead = '適中';
                analysisData.foreheadDesc = '額頭適中者運勢平穩，智慧與行動力平衡，麻衣相法認為這是穩健發展之相。';
            }
            
            // 眉毛分析
            const leftEyebrowAngle = calculateAngle(points[17], points[21]);
            const rightEyebrowAngle = calculateAngle(points[22], points[26]);
            const avgEyebrowAngle = (leftEyebrowAngle + rightEyebrowAngle) / 2;
            
            if (avgEyebrowAngle > 20) {
                analysisData.eyebrows = '上揚';
                analysisData.eyebrowsDesc = '眉毛上揚者通常性格積極，行動力強，有領導才能。麻衣相法認為此乃事業成功之相。';
            } else if (avgEyebrowAngle < 10) {
                analysisData.eyebrows = '下垂';
                analysisData.eyebrowsDesc = '眉毛下垂者通常性格溫和，富同情心，人際關係良好。麻衣相法認為此乃人緣旺盛之相。';
            } else {
                analysisData.eyebrows = '平直';
                analysisData.eyebrowsDesc = '眉毛平直者性格穩重，思慮周全，做事有條理。麻衣相法認為此乃穩健發展之相。';
            }
            
            // 眼睛分析
            const leftEyeWidth = points[39].x - points[36].x;
            const rightEyeWidth = points[45].x - points[42].x;
            const avgEyeWidth = (leftEyeWidth + rightEyeWidth) / 2;
            
            if (avgEyeWidth > 28) {
                analysisData.eyes = '大眼';
                analysisData.eyesDesc = '眼睛大者通常情感豐富，直覺敏銳，具有藝術天分。麻衣相法認為大眼者人緣佳，桃花運旺盛。';
            } else if (avgEyeWidth < 22) {
                analysisData.eyes = '小眼';
                analysisData.eyesDesc = '眼睛小者通常觀察力強，專注力高，做事謹慎。麻衣相法認為小眼者財運穩健，善於理財。';
            } else {
                analysisData.eyes = '適中';
                analysisData.eyesDesc = '眼睛大小適中者性格平衡，待人接物得體。麻衣相法認為此乃平穩發展之相。';
            }
            
            // 鼻子分析
            const noseWidth = points[35].x - points[31].x;
            const noseHeight = points[33].y - points[27].y;
            const noseRatio = noseWidth / noseHeight;
            
            if (noseRatio > 0.85) {
                analysisData.nose = '大鼻';
                analysisData.noseDesc = '鼻子大者通常意志堅定，執行力強，財運旺盛。麻衣相法認為大鼻乃財富積累之相。';
            } else if (noseRatio < 0.65) {
                analysisData.nose = '小鼻';
                analysisData.noseDesc = '鼻子小者通常心思細膩，善於規劃。麻衣相法認為小鼻者需靠專業技能發展。';
            } else {
                analysisData.nose = '適中';
                analysisData.noseDesc = '鼻子大小適中者理財觀念平衡，事業發展穩健。麻衣相法認為此乃穩健富足之相。';
            }
            
            // 嘴巴分析
            const mouthWidth = points[54].x - points[48].x;
            const faceWidthRatio = mouthWidth / faceWidth;
            
            if (faceWidthRatio > 0.5) {
                analysisData.mouth = '大嘴';
                analysisData.mouthDesc = '嘴巴大者通常表達能力強，社交能力佳，事業發展空間大。麻衣相法認為此乃領導者之相。';
            } else if (faceWidthRatio < 0.4) {
                analysisData.mouth = '小嘴';
                analysisData.mouthDesc = '嘴巴小者通常謹言慎行，專注力高，適合專業領域發展。麻衣相法認為此乃專業人才之相。';
            } else {
                analysisData.mouth = '適中';
                analysisData.mouthDesc = '嘴巴大小適中者表達能力與行動力平衡。麻衣相法認為此乃穩健發展之相。';
            }
            
            // 下巴分析
            const jawWidth = points[16].x - points[0].x;
            const jawAngle = calculateAngle(points[3], points[8], points[13]);
            
            if (jawAngle > 130) {
                analysisData.jaw = '圓潤';
                analysisData.jawDesc = '下巴圓潤者通常性格溫和，晚年運勢佳，家庭生活幸福。麻衣相法認為此乃福氣之相。';
            } else if (jawAngle < 110) {
                analysisData.jaw = '方正';
                analysisData.jawDesc = '下巴方正者通常意志堅定，執行力強，事業成就高。麻衣相法認為此乃事業成功之相。';
            } else {
                analysisData.jaw = '適中';
                analysisData.jawDesc = '下巴線條適中者性格穩健，事業與家庭平衡。麻衣相法認為此乃平穩發展之相。';
            }
            
            // 整體分析
            analysisData.overall = generateOverallAnalysis();
        }

        // 計算角度
        function calculateAngle(p1, p2, p3) {
            if (!p3) {
                // 兩點角度
                return Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
            }
            
            // 三點角度
            const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
            const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
            const dot = v1.x * v2.x + v1.y * v2.y;
            const mag1 = Math.sqrt(v1.x * v1.x + v1.y * v1.y);
            const mag2 = Math.sqrt(v2.x * v2.x + v2.y * v2.y);
            const angle = Math.acos(dot / (mag1 * mag2)) * 180 / Math.PI;
            return angle;
        }

        // 生成整體分析
        function generateOverallAnalysis() {
            const traits = [
                analysisData.faceShape,
                analysisData.forehead,
                analysisData.eyebrows,
                analysisData.eyes,
                analysisData.nose,
                analysisData.mouth,
                analysisData.jaw
            ];
            
            const positiveCount = traits.filter(t => 
                t.includes('寬闊') || t.includes('飽滿') || t.includes('上揚') || 
                t.includes('大眼') || t.includes('大鼻') || t.includes('圓潤')
            ).length;
            
            if (positiveCount >= 5) {
                return '上吉之相：綜合分析顯示您面相上佳，具備多項福相特徵，事業、財運、人緣等方面均有良好發展潛力。麻衣相法認為此乃富貴雙全之相。';
            } else if (positiveCount >= 3) {
                return '中吉之相：綜合分析顯示您面相良好，主要特徵平衡發展，只要善用優勢，在事業和生活上都能取得不錯成就。';
            } else {
                return '平穩之相：綜合分析顯示您面相平穩，雖無特別突出之處，但各方面發展均衡。麻衣相法認為此面相者需專注於專業領域發展。';
            }
        }

        // 顯示分析結果
        function displayAnalysisResults() {
            waitingText.style.display = 'none';
            traitList.style.display = 'grid';
            traitList.innerHTML = '';
            
            const traits = [
                { 
                    title: '臉型分析', 
                    icon: 'fas fa-user', 
                    result: analysisData.faceShape, 
                    desc: analysisData.faceShapeDesc 
                },
                { 
                    title: '額相分析', 
                    icon: 'fas fa-brain', 
                    result: analysisData.forehead, 
                    desc: analysisData.foreheadDesc 
                },
                { 
                    title: '眉相分析', 
                    icon: 'fas fa-archway', 
                    result: analysisData.eyebrows, 
                    desc: analysisData.eyebrowsDesc 
                },
                { 
                    title: '眼相分析', 
                    icon: 'fas fa-eye', 
                    result: analysisData.eyes, 
                    desc: analysisData.eyesDesc 
                },
                { 
                    title: '鼻相分析', 
                    icon: 'fas fa-mountain', 
                    result: analysisData.nose, 
                    desc: analysisData.noseDesc 
                },
                { 
                    title: '口相分析', 
                    icon: 'fas fa-comment', 
                    result: analysisData.mouth, 
                    desc: analysisData.mouthDesc 
                },
                { 
                    title: '下巴分析', 
                    icon: 'fas fa-chess-rook', 
                    result: analysisData.jaw, 
                    desc: analysisData.jawDesc 
                },
                { 
                    title: '整體分析', 
                    icon: 'fas fa-star', 
                    result: '綜合評斷', 
                    desc: analysisData.overall 
                }
            ];
            
            traits.forEach(trait => {
                const card = document.createElement('div');
                card.className = 'trait-card';
                card.innerHTML = `
                    <h4><i class="${trait.icon}"></i> ${trait.title}：${trait.result}</h4>
                    <p>${trait.desc}</p>
                `;
                traitList.appendChild(card);
            });
        }

        // 切換網格顯示
        meshBtn.addEventListener('click', () => {
            showMesh = !showMesh;
            meshBtn.innerHTML = showMesh 
                ? '<i class="fas fa-eye-slash"></i> 隱藏分析網格' 
                : '<i class="fas fa-eye"></i> 顯示分析網格';
            drawFaceMesh();
        });

        // 導出JSON
        exportBtn.addEventListener('click', () => {
            if (!analysisData.faceShape) return alert('請先進行面相分析');
            
            const dataStr = JSON.stringify(analysisData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = '麻衣相法分析報告.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>